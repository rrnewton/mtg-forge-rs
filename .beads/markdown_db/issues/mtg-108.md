---
title: 'Complex mana source handling: port Java Forge mana payment system'
status: open
priority: 1
issue_type: epic
labels:
  - tracking
created_at: "2025-10-28T00:00:00Z"
updated_at: "2025-10-28T00:00:00Z"
---

# Description

Implement complex mana source handling to support dual lands, City of Brass, and other lands that produce multiple color choices. This is currently blocking Old School 93/94 decks from running.

## Current Problem

The mana engine (src/game/mana_engine.rs:279) panics when encountering complex mana sources:

```rust
todo!("Complex mana source handling not yet implemented. This will require a small search process to handle lands like City of Brass that can produce any color, or dual lands that produce {{R}} OR {{G}}.");
```

**Blocking test case:**
```bash
cargo run --bin mtg -- tui --p1=random --p2=random \
  decks/old_school/01_rogue_rogerbrand.dck \
  decks/old_school/01_rogue_rogerbrand.dck
```

## Architecture Goals

1. **Minimal Interface Design**: Define a clean interface for mana payment resolution
2. **Multiple Implementations**: Support different strategies behind the same interface:
   - Java Forge greedy algorithm (initial implementation)
   - Future: Complete backtracking search
   - Future: Optimal graph-based solver
3. **Isolation**: Keep Java Forge complexity isolated in one implementation

## Interface Design

The core interface should provide:

```rust
trait ManaPaymentResolver {
    /// Given a mana cost and available sources, determine if payment is possible
    /// and return a tap order if so.
    fn can_pay(&self, cost: &ManaCost, sources: &[ManaSource]) -> bool;

    /// Compute the actual tap order for paying a cost
    fn compute_tap_order(&self, cost: &ManaCost, sources: &[ManaSource])
        -> Option<Vec<CardId>>;
}
```

## Phased Implementation

### Phase 1: Foundations
- Define `ManaSource` trait/struct representing a mana-producing permanent
- Define `ManaPaymentResolver` trait
- Refactor current `ManaEngine` to use the new interface
- Tests: Verify simple sources still work through new interface

### Phase 2: Costless Complex Sources
- Implement greedy resolver for costless complex sources
- Handle dual lands: Taiga, Tundra, Underground Sea, etc. (produce {R} OR {G}, etc.)
- Handle multicolor lands: City of Brass (produces any color)
- Handle filter lands: Mystic Gate, etc.
- Tests: Old School decks should run without panic

### Phase 3: Sources with Costs
- Handle lands with tap costs: "Pay {1}: Add {G}"
- Handle conditional sources: "Add {G} if you control a Forest"
- Handle pain lands: "T: Add {C}. T: Add {U} or {B}, this deals 1 damage to you"
- Tests: More complex Modern/Legacy decks

### Phase 4: Creature Mana Abilities
- Recognize creatures with mana abilities: Llanowar Elves, Birds of Paradise
- Handle summoning sickness
- Handle creature-based ramp
- Tests: Mana dork decks

### Phase 5: Optimization
- Implement color preference heuristics (save correct colors for later)
- Port ComputerUtilMana priority system from Java Forge
- Handle special cases: painlands, fetchlands, etc.
- Performance: Ensure <1ms for typical cases

## Java Forge Reference

**Key files:**
- `forge-java/forge-ai/src/main/java/forge/ai/ComputerUtilMana.java`
  - `payManaCost()`: Main payment algorithm
  - `scoreManaProducingCard()`: Priority scoring
- `forge-java/forge-game/src/main/java/forge/game/mana/ManaPool.java`
  - Mana pool management
- `forge-java/forge-game/src/main/java/forge/game/spellability/AbilityManaPart.java`
  - Mana ability representation

**Java approach:**
1. **Greedy algorithm**: Sorts mana sources by priority score
2. **Color constraints**: Matches specific color requirements first
3. **Generic last**: Uses remaining sources for generic mana
4. **Heuristics**: Prefers to save versatile sources for later (e.g., don't tap dual lands unless needed)

## Test Plan

### Unit Tests
- [ ] Simple sources through new interface
- [ ] Dual lands: Taiga ({R} or {G})
- [ ] City of Brass (any color)
- [ ] Mixed simple + complex sources
- [ ] Sources with costs
- [ ] Insufficient mana edge cases

### Integration Tests
- [ ] Old School 93/94 decks run without panic
- [ ] Random controller plays games with dual lands
- [ ] Heuristic controller makes reasonable choices

### Performance Tests
- [ ] Mana resolution <1ms for typical cases
- [ ] Benchmark complex boards (10+ lands, 3+ colors)

## Success Criteria

- [ ] Old School decks run successfully with random/heuristic controllers
- [ ] No panics when encountering complex mana sources
- [ ] Clean interface allows future optimization implementations
- [ ] Test coverage for all complex source types
- [ ] Documentation explains the system architecture

## Related Issues

- decks/old_school/README.md: Documents the blocking issue
- src/game/mana_engine.rs:279: The todo!() that needs fixing
- src/game/heuristic_controller.rs:872: TODO about mana tapping order
- src/game/random_controller.rs:143: TODO about mana colors and optimization
