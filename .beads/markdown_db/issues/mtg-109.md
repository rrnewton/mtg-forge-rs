---
title: Finish getting stress tests to pass
status: in_progress
priority: 2
issue_type: task
depends_on:
created_at: "2025-10-29T10:52:33-07:00"
updated_at: "2025-10-29T22:40:00-07:00"
---
# Description

Stress test with: `./tests/run_stress_tests.sh  --sequential`

If there are any remaining failures on `tests/run_stress_tests.sh`...
- Think about the deterministic simulation problem from first principles.
- Come up with some hypothesis about what invariants should hold.
- Add debugging checks and logs to check those invariants.
- Debug until the stress tests all pass, but do not remove the basic passing requirement that game action logs and final state match (modulo a small amount of stripped nondeterministic state).

Here are some principles to remember:

- separation of state



## Current Status (2025-10-29 22:40, commit f7906643)

**Test Results: 4/6 tests passing**
- ✅ All heuristic vs heuristic tests pass
- ❌ Random vs heuristic tests fail intermittently

### Root Cause Identified

Using `--debug-state-hash` flag, found that **actions are being skipped during multi-segment replay**!

Example divergence:
```
Normal game:
  [STATE:921b2e7a] Bob draws
  [STATE:612c4b98] Bob plays Forest (78)  <-- THIS ACTION
  [STATE:e007694f] Bob casts Grizzly Bears (85)

Multi-segment stop-go (stop after 3 choices, then resume):
  [STATE:921b2e7a] Bob draws
  [STATE:e007694f] Bob casts Grizzly Bears (85)  <-- SKIPPED FOREST PLAY!
```

The hash `612c4b98` (Bob plays Forest) is completely missing from stop-go replay.

### Investigation Summary

1. ✅ **Random controller RNG state IS being saved/restored correctly**
   - Verified RNG state advances properly between snapshots
   - Controller state serialization working as designed

2. ✅ **Single-segment stop-go works perfectly**
   - State hashes match exactly when stopping once and resuming once
   - All actions replayed correctly in simple case

3. ❌ **Multi-segment stop-go skips actions**
   - After multiple stop/resume cycles, actions start being skipped
   - Issue is NOT with RNG state preservation
   - Issue IS with the replay mechanism itself

### Hypothesis

The bug is likely in one of these areas:
1. Choice logging - maybe some choices aren't being logged?
2. Choice extraction - maybe `extract_replay_choices_for_player()` filters incorrectly?
3. ReplayController - maybe it's not consuming all replays correctly?
4. Turn boundary detection - maybe choices are being attributed to wrong turn?

### Next Steps

1. Add logging to see which choices are being extracted from snapshots
2. Add logging to ReplayController to see which choices it's consuming
3. Verify that ALL ChoicePoints are being logged (not just controller choices)
4. Check if the issue is related to priority passing vs actual choices
5. Test with `--verbosity=3` to see full choice logs during replay

### Technical Details

- Test command: `./scripts/snapshot_stress_test_single.py decks/grizzly_bears.dck random heuristic --replays 1 --seed 42`
- Divergence occurs after 2-3 stop/resume cycles
- Only affects Random controller (deterministic Heuristic works fine)
- State hash comparison added in commit f7906643

