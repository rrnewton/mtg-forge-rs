---
title: Finish getting stress tests to pass
status: in_progress
priority: 2
issue_type: task
depends_on:
created_at: "2025-10-29T10:52:33-07:00"
updated_at: "2025-10-29T22:40:00-07:00"
---
# Description

Stress test with: `./tests/run_stress_tests.sh  --sequential`

If there are any remaining failures on `tests/run_stress_tests.sh`...
- Think about the deterministic simulation problem from first principles.
- Come up with some hypothesis about what invariants should hold.
- Add debugging checks and logs to check those invariants.
- Debug until the stress tests all pass, but do not remove the basic passing requirement that game action logs and final state match (modulo a small amount of stripped nondeterministic state).

Here are some principles to remember:

- separation of state



## Status Update (2025-10-29, commit 6ace02a6)

**MAJOR FIX COMPLETED** ✅

The "missing actions" bug was NOT actually missing actions - it was missing state hash logs!

### Root Cause Found and Fixed

The state hash logging was being SUPPRESSED during replay mode. When actions were replayed
from snapshots, they executed correctly but their state hashes weren't logged to stderr.
This made it appear that actions were being skipped when comparing hash sequences.

**Example of the bug:**
```rust
// BEFORE (buggy code):
if !self.replaying {
    let play_msg = format!("{} plays {} ({})", player, card_name, card_id);
    self.game.debug_log_state_hash(&play_msg);  // Only logged if NOT replaying!
}
```

**After fix:**
```rust
// AFTER (fixed code):
let play_msg = format!("{} plays {} ({})", player, card_name, card_id);
self.game.debug_log_state_hash(&play_msg);  // Always logged!
```

### Verification

With --debug-state-hash enabled, now both normal and stop-go games show identical hash sequences:

**Normal game:**
```
[STATE:921b2e7a] Bob draws
[STATE:612c4b98] Bob plays Forest (78)  ← NOW PRESENT!
[STATE:e007694f] Bob casts Grizzly Bears (85)
```

**Multi-segment stop-go:**
```
[STATE:921b2e7a] Bob draws
[STATE:612c4b98] Bob plays Forest (78)  ← NOW PRESENT!
[STATE:e007694f] Bob casts Grizzly Bears (85)
```

### Current Test Status (commit 6ace02a6)

Stress tests: Still investigating remaining issues
- ✅ Heuristic vs Heuristic: All pass
- ⚠️ Random vs Heuristic: Intermittent failures remain

The remaining failures show:
- Some runs: `✓ GameStates match` (good!)
- Some runs: Different game lengths (stopgo varies between runs)
- Non-determinism still present despite RNG state preservation

### Investigation Ongoing

The core replay mechanism is now working (hashes prove actions execute). Remaining work:
1. Investigate why Random controller games aren't fully deterministic across different stop points
2. The test uses multiple replays with different random stop points - some pass, some fail
3. Need to determine if this is expected behavior or a real bug

### Technical Details

- Fixed files: `src/game/game_loop.rs`
- Affected functions: PlayLand, CastSpell, Draw actions
- Test command: `./tests/run_stress_tests.sh --sequential`

