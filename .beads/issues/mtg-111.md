---
title: Phase triggered abilities (T:Mode$ Phase)
status: open
priority: 3
issue_type: feature
created_at: 2025-10-31T03:05:33.940088241+00:00
updated_at: 2025-10-31T03:14:42.171480245+00:00
---

# Description

Implement phase-triggered abilities that fire during specific phases/steps.

## Status

**Partially implemented** - Basic infrastructure in place for detecting and logging phase triggers, but effects are not yet executed.

## What's Implemented

1. ✅ TriggerEvent enum now derives Copy (src/core/effects.rs:128)
2. ✅ Phase trigger parsing in card loader (src/loader/card.rs:583-612)
   - Detects `T:Mode$ Phase` triggers
   - Supports `Phase$ Upkeep` → BeginningOfUpkeep
   - Supports `Phase$ End` or `Phase$ EndOfTurn` → BeginningOfEndStep
   - Creates placeholder triggers with descriptions
3. ✅ Phase trigger checking in game loop (src/game/game_loop.rs:1258-1303)
   - `check_phase_triggers()` method added
   - Called from `upkeep_step()` (line 1307)
   - Called from `end_step()` (line 1728)
   - Logs trigger activation in verbose mode
4. ✅ All validation passes (388 tests passed, 1 skipped)

## What's Missing

Cards like Land Tax still won't work because:

1. ❌ **No effect parsing** - Phase triggers are created with empty effects (line 610)
   - Need to parse `Execute$` parameter (references SVar)
   - Need to parse direct effects in trigger line
2. ❌ **No condition checking** - CheckSVar$ and SVarCompare$ not supported
   - Land Tax needs: "if opponent controls more lands"
3. ❌ **No optional triggers** - OptionalDecider$ not supported
   - Land Tax is optional: "you may search..."
4. ❌ **No ValidPlayer$ filtering** - All players' upkeeps trigger, not just "You" or "Opponent"

## Impact

This change:
- Adds infrastructure for phase triggers
- Makes the engine detect phase trigger definitions
- Logs when triggers would fire (in verbose mode)
- Does NOT make cards with phase triggers actually work yet

## Next Steps

To make Land Tax and similar cards functional, we need (in order):
1. SVar resolution system (mtg-21) - parse Execute$ and SubAbility references
2. Condition evaluation - CheckSVar$ and SVarCompare$ logic  
3. Optional trigger handling - controller chooses whether to put on stack
4. ValidPlayer$ filtering - only trigger for specified players
